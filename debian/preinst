#!/bin/bash
# Debian package preinst script for Distiller CM5 SDK
# Modern Debian packaging practices

set -e

# Architecture check
check_architecture() {
	local arch=$(dpkg --print-architecture)
	if [ "$arch" != "arm64" ]; then
		cat >&2 <<EOF
ERROR: This package is only supported on arm64 architecture.
Current architecture: $arch
Installation cannot proceed.
EOF
		exit 1
	fi
}

# Check for uv package manager
check_uv() {
	# Check common installation paths
	local uv_found=false

	# Try command in current environment
	if command -v uv >/dev/null 2>&1; then
		uv_found=true
	# Check system-wide location
	elif [ -f "/usr/local/bin/uv" ] && [ -x "/usr/local/bin/uv" ]; then
		uv_found=true
	# Check actual user's home directory if using sudo
	elif [ -n "$SUDO_USER" ] && [ "$SUDO_USER" != "root" ]; then
		if [ -f "/home/$SUDO_USER/.local/bin/uv" ] && [ -x "/home/$SUDO_USER/.local/bin/uv" ]; then
			uv_found=true
		# Try to find uv in the actual user's PATH
		elif su - "$SUDO_USER" -c "command -v uv" >/dev/null 2>&1; then
			uv_found=true
		fi
	# Check current user's home
	elif [ -f "$HOME/.local/bin/uv" ] && [ -x "$HOME/.local/bin/uv" ]; then
		uv_found=true
	# Check root's home as fallback
	elif [ -f "/root/.local/bin/uv" ] && [ -x "/root/.local/bin/uv" ]; then
		uv_found=true
	fi

	if [ "$uv_found" = false ]; then
		cat >&2 <<EOF
ERROR: uv package manager is required but not installed.

Please install uv first by running:
  curl -LsSf https://astral.sh/uv/install.sh | sh

Or if you prefer wget:
  wget -qO- https://astral.sh/uv/install.sh | sh

After installation, ensure uv is in your PATH and try again.
EOF
		exit 1
	fi
}

# No longer checking for a specific user - will use the current user during installation

# Main logic
case "$1" in
install | upgrade)
	# Perform architecture check
	check_architecture

	# Check for uv package manager
	check_uv
	;;

abort-upgrade)
	# No action needed
	;;

*)
	echo "preinst called with unknown argument: $1" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
