#!/bin/bash
set -e

# Export PATH with all possible uv locations
export PATH="/root/.local/bin:/root/.cargo/bin:$HOME/.local/bin:$HOME/.cargo/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Function to detect hardware platform
detect_platform() {
	local platform=""
	# Allow override via environment variable
	if [ -n "$DISTILLER_PLATFORM" ]; then
		echo "INFO: Platform override: $DISTILLER_PLATFORM" >&2
		platform="$DISTILLER_PLATFORM"
	elif [ -f /proc/device-tree/compatible ]; then
		local compat
		compat=$(tr '\0' '\n' </proc/device-tree/compatible)
		if echo "$compat" | grep -q -e "radxa,zero3" -e "rockchip,rk3566"; then
			platform="radxa"
			echo "INFO: Detected platform: Rockchip RK3566 (Radxa compatible)" >&2
		elif echo "$compat" | grep -q -e "raspberrypi,5" -e "bcm2712"; then
			platform="cm5"
			echo "INFO: Detected platform: Raspberry Pi CM5" >&2
		fi
	fi

	if [ -z "$platform" ]; then
		echo "ERROR: Could not detect platform" >&2
		exit 1
	fi

	echo "$platform"
}

# Main installation logic
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ]; then
	echo "INFO: Setting up Distiller SDK..."

	# Detect platform for hardware configuration
	PLATFORM=$(detect_platform)

	# Install platform-specific eink configuration
	if [ "$PLATFORM" = "radxa" ]; then
		CONFIG_FILE="/opt/distiller-cm5-sdk/configs/radxa-zero3.conf"
		PLATFORM_DESC="Radxa Zero 3/3W (RK3566)"
		SPI_DEVICE="/dev/spidev3.0"
		GPIO_CHIP="/dev/gpiochip3"
		GPIO_PINS="DC=8 (GPIO3_B0), RST=2 (GPIO3_A2), BUSY=1 (GPIO3_A1)"
	else
		CONFIG_FILE="/opt/distiller-cm5-sdk/configs/cm5.conf"
		PLATFORM_DESC="Raspberry Pi CM5"
		SPI_DEVICE="/dev/spidev0.0"
		GPIO_CHIP="/dev/gpiochip0"
		GPIO_PINS="DC=7, RST=13, BUSY=9"
	fi

	cp "$CONFIG_FILE" /opt/distiller-cm5-sdk/eink.conf

	cd /opt/distiller-cm5-sdk

	echo "INFO: Setting up virtual environment with uv..."

	[ -d ".venv" ] && rm -rf ".venv"
	if ! uv venv --system-site-packages 2>/dev/null; then
		echo "INFO: Creating venv without system-site-packages..."
		uv venv || {
			echo "WARNING: Failed to create virtual environment with uv"
			exit 1
		}
	fi

	# Install dependencies
	uv sync

	VENV_PATH="/opt/distiller-cm5-sdk/.venv"

	# Set appropriate permissions
	chmod -R a+r /opt/distiller-cm5-sdk
	find /opt/distiller-cm5-sdk -type d -exec chmod 755 {} \; \
		-o -type f -name "*.py" -exec chmod 644 {} \;
	find /opt/distiller-cm5-sdk/.venv/bin -type f -exec chmod 755 {} \;

	# Verify installation
	VENV_PYTHON="$VENV_PATH/bin/python"
	if [ ! -f "$VENV_PYTHON" ]; then
		echo "ERROR: Virtual environment setup failed"
		exit 1
	fi

	echo "INFO: Verifying Python installation..."
	if ! $VENV_PYTHON -c "import sys; print(f'INFO: Python {sys.version}')" 2>/dev/null; then
		echo "ERROR: Python environment verification failed"
		exit 1
	fi

	echo "INFO: Testing SDK imports..."
	if ! $VENV_PYTHON -c "import distiller_cm5_sdk; print('INFO: SDK imported successfully')" 2>/dev/null; then
		echo "ERROR: distiller_cm5_sdk import failed"
		exit 1
	fi

	# Create activation script
	cat >/opt/distiller-cm5-sdk/activate.sh <<'EOF'
#!/bin/bash
# Activate the distiller-cm5-sdk virtual environment
source /opt/distiller-cm5-sdk/.venv/bin/activate
export PYTHONPATH="/opt/distiller-cm5-sdk/src:$PYTHONPATH"
export LD_LIBRARY_PATH="/opt/distiller-cm5-sdk/lib:$LD_LIBRARY_PATH"
echo "Distiller SDK environment activated"
EOF
	chmod 755 /opt/distiller-cm5-sdk/activate.sh

	# Platform-specific device checks
	if [ "$PLATFORM" = "radxa" ]; then
		[ -e "/dev/spidev3.0" ] || {
			echo "WARNING: /dev/spidev3.0 not found!"
			echo "Enable overlay: spi3-m1-cs0-spidev"
		}
		[ -e "/dev/gpiochip3" ] || echo "WARNING: /dev/gpiochip3 not found!"
	else
		[ -e "/dev/spidev0.0" ] || {
			echo "WARNING: /dev/spidev0.0 not found!"
			echo "Please enable SPI in raspi-config or /boot/config.txt"
		}
		[ -e "/dev/gpiochip0" ] || echo "WARNING: /dev/gpiochip0 not found!"
	fi

	# Update shared library cache
	ldconfig

	echo ""
	echo "============================================="
	echo "Distiller SDK installed successfully!"
	echo "============================================="
	echo ""
	echo "Platform: $PLATFORM_DESC"
	echo "Config: /opt/distiller-cm5-sdk/eink.conf"
	echo ""
	echo "To activate the environment, run:"
	echo "  source /opt/distiller-cm5-sdk/activate.sh"
	echo ""
fi
