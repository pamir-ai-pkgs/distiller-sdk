#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all

%:
	dh $@ --with python3

override_dh_auto_build:
	# Build step is handled by Justfile prepare recipe which runs build.sh to:
	# 1. Download AI models from HuggingFace
	# 2. Build the Rust e-ink display library for ARM64
	# This ensures all assets are ready for packaging
	true

	# Clean up Rust build artifacts before packaging
	rm -rf src/distiller_sdk/hardware/eink/lib/target
	rm -f src/distiller_sdk/hardware/eink/lib/target-build

override_dh_auto_install:
	dh_auto_install

	# Clean up setuptools build artifacts that shouldn't be packaged
	rm -rf $(CURDIR)/debian/distiller-sdk/opt/distiller-sdk/build
	rm -rf $(CURDIR)/debian/distiller-sdk/opt/distiller-sdk/src/distiller_sdk.egg-info
	rm -rf $(CURDIR)/debian/distiller-sdk/opt/distiller-sdk/bin
	rm -rf $(CURDIR)/debian/distiller-sdk/opt/distiller-sdk/models

	# Post-install cleanup and library linking
	rm -rf $(CURDIR)/debian/distiller-sdk/opt/distiller-sdk/src/distiller_sdk/hardware/eink/lib
	mkdir -p $(CURDIR)/debian/distiller-sdk/usr/lib
	ln -sf /opt/distiller-sdk/lib/libdistiller_display_sdk_shared.so \
		$(CURDIR)/debian/distiller-sdk/usr/lib/libdistiller_display_sdk_shared.so

override_dh_python3:
	# Skip dh_python3 since we're using uv for Python environment management
	true

override_dh_fixperms:
	dh_fixperms
	find $(CURDIR)/debian/distiller-sdk -name .gitignore -delete

override_dh_strip:
	# Strip locally-built Rust library
	dh_strip --exclude=piper/ --no-automatic-dbgsym

override_dh_shlibdeps:
	dh_shlibdeps --exclude=piper/ --exclude=libdistiller_display_sdk_shared.so
